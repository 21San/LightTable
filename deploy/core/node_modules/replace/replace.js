var fs = require("fs"),
    path = require("path");

function canSearch(file, isFile) {
  return true;
}

function binaryFile(text) {
  return text.indexOf("\0\0") > -1;
}

function replacizeFileSync(file, options) {
  var stats = fs.lstatSync(file);
  if (stats.isSymbolicLink()) {
    // don't follow symbolic links for now
    return;
  }
  var isFile = stats.isFile();
  if (!canSearch(file, isFile)) {
    return;
  }
  if (isFile) {
    var text = fs.readFileSync(file, "utf-8");
    if(!binaryFile(text)) {
      text = replacizeText(text, file, options);
      if (options.canReplace && text !== null) {
        fs.writeFileSync(file, text);
      }
    }
  }
  else if (stats.isDirectory() && options.recursive) {
    var files = fs.readdirSync(file);
    for (var i = 0; i < files.length; i++) {
      if(!options.exclude || !files[i].match(options.exclude)) {
        replacizeFileSync(path.join(file, files[i]), options);
      }
    }
  }
}

function replacizeText(text, file, options) {
  if (!text.match(options.regex)) {
    return;
  }
  var results = [];
  var lines = text.split("\n");
  for (var i = 0; i < lines.length; i++) {
    var line = lines[i];
    if (line.match(options.regex)) {
      line = line.replace(options.regex, "<em>$&</em>");
      results.push({line: i+1, text: line.slice(0,options.limit)});
    }
  }
  options.result({file: file, results: results});
  if (options.canReplace) {
    return text.replace(options.regex, options.replacement);
  }
}

var regexEscape = function(text) {
  return text.replace(/[-[\]{}()*+?.,\\^$|#\s]/g, "\\$&");
};

module.exports = function(options) {

  options.limit = 400;

  var flags = "gm"; // global multiline
  if (options.ignoreCase) {
    flags += "i";
  }

  if (options.regex instanceof RegExp) {
    options.regex = new RegExp(options.regex.source, flags);
  } else {
    options.regex = new RegExp(regexEscape(options.regex), flags);
  }

  options.canReplace = options.replacement !== undefined;

  for (var i = 0; i < options.paths.length; i++) {
    replacizeFileSync(options.paths[i], options);
  }

};
